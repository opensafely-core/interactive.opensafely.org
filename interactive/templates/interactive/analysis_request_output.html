{% extends "interactive/output_template.html" %}

{% load humanize %}

{% block meta_title %}Analysis Output | OpenSAFELY Interactive{% endblock meta_title %}

{% block content %}
<article aria-labelledby="analysisHeading">
  <header class="bg-oxford-50">
    <div class="container py-8 sm:pt-16 pb-14">
      <div class="text-center">
        <div class="flex flex-col-reverse">
          <h1 id="analysisHeading" class="mt-2 text-4xl font-bold text-slate-900 sm:text-5xl sm:tracking-tight lg:text-6xl">
            {{ analysis.title }}
          </h1>
          <p class= font-bold text-oxford-600 tracking-wide uppercase">
            Analysis Output
          </p>
        </div>
        <p class="max-w-3xl mx-auto mt-5 text-xl leading-normal text-slate-700">
          The aim of this OpenSAFELY Interactive report is to describe trends and variation in clinical codes to inform further analyses.
          It is not intended to be a tool for "performance monitoring".
        </p>
      </div>

      <div class="max-w-3xl mx-auto rounded-md bg-yellow-50 border border-yellow-300 p-4 pt-6 pb-7 mt-6">
        <div class="flex">
          <div class="flex-shrink-0">
            {% include "icons/solid-exclamation.svg" with html_class="h-6 w-6 text-yellow-500" %}
          </div>
          <div class="ml-3 font-semibold text-yellow-800">
            <p class="mb-3">Sharing outside of NHS England is not permitted in the current pilot phase without further approvals.</p>
            <p>Please contact the {% include "components/link.html" with href="mailto:team@opensafely.org" content="OpenSAFELY Team" %} if you would like to seek approval for wider sharing.</p>
          </div>
        </div>
      </div>
    </div>
  </header>

  <div class="container pt-8">
    <div class="grid md:grid-cols-2 gap-8">
      <section class="bg-white shadow overflow-hidden sm:rounded-lg text-slate-700">
        <dl class="px-4 py-4 sm:px-6 grid grid-cols-1 gap-y-6">
          <div>
            <dt class="text-slate-600 font-semibold mb-1">Requested codelist</dt>
            <dd>
              {% include "components/link.html" with href="https://www.opencodelists.org/codelist/"|add:analysis.codelist_slug content=analysis.codelist_name %}
            </dd>
          </div>
          <div>
            <dt class="text-slate-600 font-semibold mb-1">Time period</dt>
            <dd>
              {{ analysis.start_date }} to {{ analysis.end_date }}
            </dd>
          </div>
        </dl>
      </section>

      <section>
        <div class="md:-mx-6 lg:-mx-8">
          <div class="min-w-full align-middle md:px-6 lg:px-8">
            <div class="overflow-hidden shadow sm:rounded-lg">
              <table class="min-w-full divide-y divide-slate-300">
                <tbody class="divide-y divide-slate-200 bg-white">
                  <tr class="divide-x divide-slate-200">
                    <th scope="row" class="whitespace-nowrap px-4 py-3.5 text-left font-semibold text-slate-900">
                      Unique events
                    </th>
                    <td class="whitespace-nowrap p-4 text-slate-700 font-mono">
                      {{ summary.0.count|intcomma }}
                    </td>
                  </tr>
                  <tr class="divide-x divide-slate-200">
                    <th scope="row" class="whitespace-nowrap px-4 py-3.5 text-left font-semibold text-slate-900">
                      Events in latest week
                    </th>
                    <td class="whitespace-nowrap w-full p-4 text-slate-700 font-mono">
                      {{ summary.1.count|intcomma }}
                    </td>
                  </tr>
                  <tr class="divide-x divide-slate-200">
                    <th scope="row" class="whitespace-nowrap px-4 py-3.5 text-left font-semibold text-slate-900">
                      Unique patients
                    </th>
                    <td class="whitespace-nowrap w-full p-4 text-slate-700 font-mono">
                      {{ summary.2.count|intcomma }}
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </section>
    </div>
  </div>

  <div class="container xl:max-w-6xl pt-8">
    <section class="bg-white shadow overflow-hidden sm:rounded-lg">
      <h2 class="text-2xl font-bold text-center py-4 mb-6 text-slate-700 border-b border-slate-100">Trends and variation in code use</h2>
      <figure>
        <img class="mx-auto block mb-4 px-4" src="data:image;base64,{{ deciles_chart }}" />
        <figcaption class="block font-semibold text-center text-slate-600 border-t border-slate-100 p-4">
          Figure: The weekly event rate for the selected codelist per 1000 registered patients per practice
        </figcaption>
      </figure>
      <div class="mx-auto mb-8 px-4 prose prose-oxford">
        <p>
          This figure shows practice level variation in code use as a deciles chart. Any practices showing no code use throughout the entire period are removed before the decile chart is generated.{% if practices %} For this analysis {{ practices.with_at_least_1_event }}/{{ practices.total }} practices had at least one coded event of interest during the study period.{% endif %}
        </p>
        <p>All practices are ranked by their rates over 4-weekly intervals and only the values for the median (50th percentile) practice, and 10th, 20th percentile etc are shown.</p>
        <!-- <p>
          For more information on why we use deciles charts to communicate variation in coding activity please see our {% include "components/link.html" with href="about/" content="About page" %}.
        </p> -->
      </div>
    </section>
  </div>

  <div class="container xl:max-w-6xl pt-8">
    <section class="bg-white shadow overflow-hidden sm:rounded-lg">
      <h2 class="text-2xl font-bold text-center py-4 mb-6 text-slate-700 border-b border-slate-100">
        Most common codes
      </h2>
      <div class="mx-auto prose prose-oxford">
        <table>
          <thead>
            <th>Code</th>
            <th>Description</th>
            <th>Proportion of codes (%)</th>
          </thead>
          {% for code in common_codes %}
            <tbody>
              <td class="font-mono">{{ code.Code }}</td>
              <td>{{ code.Description }}</td>
              <td class="font-mono">{{ code.Proportion }}</td>
            </tbody>
          {% endfor %}
        </table>
      </div>
      <p class="block font-semibold text-center text-slate-600 border-t border-slate-100 mt-6 py-4">
        {% include "components/link.html" with href="https://www.opencodelists.org/codelist/"|add:analysis.codelist_slug content="Link to Codelist" %}
      </p>
    </section>
  </div>

  <div class="container py-8">
    <section class="bg-white max-w-3xl mx-auto px-4 pb-8 shadow overflow-hidden sm:rounded-lg">
      <h2 class="text-2xl font-bold text-center py-4 mb-6 text-slate-700 border-b border-slate-100">
        More information
      </h2>
      <div class="mx-auto prose prose-oxford">
        <ul>
          <li>Unique events represents a maximum of one event per patient per day</li>
          <li>All patient counts are rounded to the nearest 10. Practice counts are rounded to the nearest 5</li>
          <li>The practice population value is approximated as those registered as of the latest date in the analysis period, plus patients who died at any time during the period while registered with a TPP practice</li>
          <li>Figures shown should be interpreted cautiously. Results only show newly recorded coding events, not the total number of people who have had a particular code to date</li>
          <li>If your codelist represents diagnoses or demographic features note that: codes may only be entered only once for each patient and may not be captured in this time period; new codes do not necessarily represent new diagnoses because duplicate codes may be added in specific clinical contexts</li>
          <li>Further analyses in {% include "components/link.html" with href="https://www.opensafely.org/onboarding-new-users/" content="OpenSAFELY" %} can help to understand these patterns better; you may wish to discuss these analyses with an experienced electronic health records researcher or analyst who understands how such codes are used</li>
          </li>
        </ul>
      </div>
    </section>
  </div>

</article>
{% endblock content %}
