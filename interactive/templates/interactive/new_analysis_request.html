{% extends "interactive/template.html" %}
{% load django_vite %}

{% block meta_title %}Request an analysis | OpenSAFELY Interactive{% endblock meta_title %}

{% block template_heading %}
<h1 class="text-center text-3xl font-extrabold text-slate-900 sm:w-full sm:max-w-lg mx-auto">
  Request an analysis
</h1>
{% endblock template_heading %}

{% block template_content %}
<div class="border-l-2 border-l-oxford-200 bg-oxford-50 pl-4 pr-2 py-4 -mx-4 -mt-4 rounded">
    <details class="prose prose-oxford text-slate-800 prose-sm mx-auto">
      <summary class="text-lg font-bold cursor-pointer">
        <span class="pl-1">What does an analysis show?</span>
      </summary>
      <p>This is an interactive tool that automatically counts, for a {% include "components/link.html" with href="https://www.opencodelists.org/" content="selected codelist" newtab=True %}, the number of events recorded per week in every GP practice using TPP software (~40% of England's practices), from prior to the pandemic to the latest available date (approximately 1-2 weeks lag time).</p>
      {% url 'about' as deciles_link %}
      <p>This produces a time trend chart, with practices are represented as {% include "components/link.html" with href=deciles_link|add:"#deciles" content="deciles" newtab=True %}.</p>
      <p>The report will also display overall summary statistics (total events, number of distinct patients affected) and which five codes in the codelist were most commonly used, with percentages.</p>
    </details>
</div>

<div class="border-t border-t-slate-200 mt-6 pt-4 -mx-4">
  <h2 class="px-4 text-xl font-bold">Submit a request</h2>
</div>

{% if form.errors %}
<div class="shadow sm:rounded-lg bg-red-50 p-4 mt-3 mb-6">
  <div class="flex">
    <div class="flex-shrink-0">
      {% include "icons/solid-x-circle.svg" with html_class="h-5 w-5 text-red-400" %}
    </div>
    <div class="ml-3">
      <h3 class="text-sm font-bold text-red-800">
        There {{ form.errors|pluralize:"was,were" }} {{ form.errors|length }} error{{form.errors|pluralize}}:
      </h3>
      <div class="mt-2 text-sm text-red-700">
        <ul role="list" class="list-disc pl-5 space-y-1">
          {% for field in form %}
            {% for error in field.errors %}
            <li><strong>{{ field.label }}: </strong>{{ error }}</li>
            {% endfor %}
          {% endfor %}
          {% for error in form.non_field_errors %}
            <li>{{ error }}</li>
          {% endfor %}
        </ul>
      </div>
    </div>
  </div>
</div>
{% endif %}

<form class="space-y-6" method="post">
  {% csrf_token %}
  {{ form.non_field_errors }}

  <div>
    {% include "components/form-field.html" with id=form.title.id_for_label label=form.title.label name="title" required=True type="text" hint="For example: Systolic code usage" %}
    {% if form.title.errors %}
      <ul class="mt-2">
        {% for error in form.title.errors %}
          <li class="text-sm text-red-700">{{ error }}</li>
        {% endfor %}
      </ul>
    {% endif %}
  </div>

  {{ form.codelist_slug.field.choices|json_script:"react-dropdown-options" }}
  {{ form.codelist_slug.errors|json_script:"react-dropdown-errors" }}
  <div
    data-choices="react-dropdown-options"
    data-errors="react-dropdown-errors"
    data-hint="Codelists are published by OpenSAFELY on OpenCodelists and use the SNOMED CT coding system"
    data-id="{{ form.codelist_slug.id_for_label }}"
    data-label="Codelists"
    data-name="codelist_slug"
    id="react-dropdown"
    ></div>
  {% if debug %}
  <script type="module">
    import RefreshRuntime from 'http://localhost:3000/@react-refresh'
    RefreshRuntime.injectIntoGlobalHook(window)
    window.$RefreshReg$ = () => {}
    window.$RefreshSig$ = () => (type) => type
    window.__vite_plugin_react_preamble_installed__ = true
  </script>
  {% endif %}
  {% vite_asset 'assets/src/scripts/dropdown.jsx' defer=true %}

  <div>
    <h2 class="text-base font-semibold text-slate-700">
      Date range
    </h2>
    <p class="mt-1 text-base text-slate-600">
      Analysis will cover period between
      <time class="font-mono" datetime="{{ start_date }}">{{ start_date }}</time>
      and
      <time class="font-mono" datetime="{{ end_date }}">{{ end_date }}</time>
    </p>
  </div>

  {% include "components/button.html" with el="input" color="oxford" html_class="w-full" size="lg" type="submit" text="Submit" %}
</form>
{% endblock template_content %}
